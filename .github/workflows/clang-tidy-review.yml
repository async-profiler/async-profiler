name: clang-tidy-review

on:
  workflow_run:
    workflows:
      - code-check
    types:
      - completed

jobs:
  publish-clang-tidy-review:
    permissions:
      pull-requests: write
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/github-script@v7
        with:
          script: |
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            let matchArtifact = allArtifacts.data.artifacts.filter((artifact) => {
              return artifact.name == "code-check-artifacts"
            })[0];
            let download = await github.rest.actions.downloadArtifact({
               owner: context.repo.owner,
               repo: context.repo.repo,
               artifact_id: matchArtifact.id,
               archive_format: 'zip',
            });
            const fs = require('fs');
            fs.writeFileSync('code-check-artifacts.zip', Buffer.from(download.data));
      - name: Unzip artifact
        run: unzip code-check-artifacts.zip -d .
      - name: Read Pull Request ID
        id: read_pr_id
        run: |
          echo "pr_id=$(cat pull-request-id.txt)" >> $GITHUB_OUTPUT
      - name: Run clang-tidy-pr-comments action
        if: github.event.pull_request.draft == false
        uses: platisd/clang-tidy-pr-comments@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          pull_request_id: ${{ steps.read_pr_id.outputs.pr_id }}
          clang_tidy_fixes: clang-tidy-fixes.yml
          python_path: python
          auto_resolve_conversations: true
          suggestions_per_comment: 100
          repo_path_prefix: /__w/async-profiler
